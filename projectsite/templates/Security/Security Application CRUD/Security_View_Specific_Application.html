{% load static %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" href="{% static 'images/favicon.png' %}">
<body class="bg-dark">
    <div class="container mt-5">
        <div class="card shadow p-4" style="background-color: #1e1e1e; border: 1px solid #333; color: #fff;">
            <h3 class="mb-4 text-center" style="color: #fff; border-bottom: 2px solid #FFD700; padding-bottom: 10px;">Registration Details</h3>

            <div class="list-group">
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Date Submitted:</strong> 
                    <span class="text-white">{{ registration.created_at|date:"F d, Y" }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Google Drive Link:</strong> 
                    <a href="#" class="view-file-link float-end text-white" data-url="{{ registration.files }}">View File</a>
                </div>
                <!-- Rest of content remains the same -->
                <h2>Personal Information</h2>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Applicant Name:</strong> 
                    <span class="float-end text-white">{{ registration.user.lastname }}, {{ registration.user.firstname }} {{ registration.user.middle_name|default_if_none:""|slice:":1" }}. {{ registration.user.suffix|default_if_none:""}}</span>
                </div>
                <!-- Other personal information fields... -->
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Corporate Email:</strong> 
                    <span class="float-end text-white">{{ registration.user.corporate_email }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Address:</strong> 
                    <span class="float-end text-white">{{ registration.user.address }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Institutional Role:</strong> 
                    <span class="float-end text-white">{{ registration.user.school_role }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Department / Workplace:</strong> 
                    <span class="float-end text-white">{{ registration.user.department }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">College:</strong> 
                    <span class="float-end text-white">{{ registration.user.college }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Program:</strong> 
                    <span class="float-end text-white">{{ registration.user.program }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Driver's License Number:</strong> 
                    <span class="float-end text-white">{{ registration.user.dl_number }}</span>
                </div>
                <h2>Vehicle Information</h2>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Type:</strong> 
                    <span class="float-end text-white">{{ registration.vehicle.get_type_display|title }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Color:</strong> 
                    <span class="float-end text-white">{{ registration.vehicle.color }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Model:</strong> 
                    <span class="float-end text-white">{{ registration.vehicle.make_model }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Plate Number:</strong> 
                    <span class="float-end text-white">{{ registration.vehicle.plate_number }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">Chassis Number:</strong> 
                    <span class="float-end text-white">{{ registration.vehicle.chassis_number }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">OR Number:</strong> 
                    <span class="float-end text-white">{{ registration.vehicle.or_number }}</span>
                </div>
                <div class="list-group-item bg-dark border-secondary mb-2">
                    <strong style="color: #FFD700;">CR Number:</strong> 
                    <span class="float-end text-white">{{ registration.vehicle.cr_number }}</span>
                </div>
            </div>

            <div class="d-flex justify-content-center gap-3 mt-4 mb-3">
                            <a href="{% url 'security_initial_approvals' %}" class="btn btn-primary" style="background-color: #FFD700; color: #000; border: none; border-radius: 20px; padding: 0.5rem 1.5rem; font-weight: bold;">
                                Return
                            </a>

                            {# Only show Review button if user is OIC and Status is 'application submitted' #}
                            {% if profile.securityprofile.level == 'oic' and registration.status == 'application submitted' %}
                            <button type="button" class="btn btn-success fw-bold" style="border-radius: 20px; padding: 0.5rem 2rem;" data-bs-toggle="modal" data-bs-target="#actionModal">
                                Review Application
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content bg-light text-dark">
                            <div class="modal-header border-bottom-0">
                                <h5 class="modal-title fw-bold" id="actionModalLabel">Application Review #{{ registration.registration_number }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            
                            <form method="post" action="{% url 'security_recommend_application' registration.pk %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <div class="alert alert-warning d-flex align-items-center" role="alert">
                                        <div class="me-2">⚠️</div>
                                        <div>
                                            You are reviewing <strong>{{ registration.vehicle.plate_number }}</strong>
                                            <div class="small">{{ registration.user.firstname }} {{ registration.user.lastname }}</div>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-3">

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">OIC Decision</label>
                                        <div class="d-flex flex-column gap-2">
                                            {% for radio in oic_form.status %}
                                                <div class="form-check p-3 border bg-white rounded shadow-sm">
                                                    {{ radio.tag }}
                                                    <label class="form-check-label w-100 fw-bold {% if 'rejected' in radio.choice_label|lower %}text-danger{% else %}text-success{% endif %}" for="{{ radio.id_for_label }}" style="cursor: pointer;">
                                                        {{ radio.choice_label }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Remarks / Notes</label>
                                        {{ oic_form.remarks }} 
                                        <div class="form-text">Required if rejecting.</div>
                                    </div>
                                </div>
                                
                                <div class="modal-footer border-top-0">
                                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary px-4">Submit Decision</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- Modal for file display -->
    <div class="modal fade" id="fileModal" tabindex="-1" aria-labelledby="fileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title text-white" id="fileModalLabel">File Viewer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 d-flex">
                    <!-- Left half: Current content -->
                    <div class="split-view h-100" style="width: 50%; overflow-y: auto; padding: 15px;">
                        <div id="registration-content">
                            <!-- Content will be cloned here by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Right half: File viewer -->
                    <div class="split-view h-100" style="width: 50%; border-left: 1px solid #333;">
                        <iframe id="file-frame" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find all file viewing links and attach click handlers
        const fileLinks = document.querySelectorAll('.view-file-link');
        
        fileLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const fileUrl = this.getAttribute('data-url');
                
                // Prepare to open a new window with proper specs for split view
                const screenWidth = window.screen.availWidth;
                const screenHeight = window.screen.availHeight;
                const windowWidth = Math.floor(screenWidth / 2);
                
                // Open Google Drive in a new window sized to the right half of the screen
                const newWindow = window.open(
                    fileUrl, 
                    '_blank',
                    `width=${windowWidth},height=${screenHeight},left=${windowWidth},top=0`
                );
                
                // If the window opened successfully, show our modal on the left half
                if (newWindow) {
                    // Focus on our original window
                    window.focus();
                    
                    // Clone the registration card content to the modal
                    const registrationContent = document.querySelector('.card').cloneNode(true);
                    const modalContent = document.getElementById('registration-content');
                    modalContent.innerHTML = '';
                    modalContent.appendChild(registrationContent);
                    
                    // Configure and show the modal to take left half
                    const modalElement = document.getElementById('fileModal');
                    
                    // Adjust modal styles for left half only
                    modalElement.querySelector('.modal-dialog').style.maxWidth = `${windowWidth}px`;
                    modalElement.querySelector('.modal-dialog').style.margin = '0';
                    modalElement.querySelector('.modal-dialog').style.height = '100vh';
                    modalElement.querySelector('.modal-content').style.height = '100%';
                    
                    // Remove the right pane since we're using a separate window
                    const rightPane = modalElement.querySelector('.split-view:last-child');
                    if (rightPane) {
                        rightPane.style.display = 'none';
                    }
                    
                    // Make the left pane take full width
                    const leftPane = modalElement.querySelector('.split-view:first-child');
                    if (leftPane) {
                        leftPane.style.width = '100%';
                    }
                    
                    // Add handler for when modal closes
                    modalElement.addEventListener('hidden.bs.modal', function() {
                        // Try to close the other window when we close the modal
                        try {
                            if (!newWindow.closed) {
                                newWindow.close();
                            }
                        } catch (e) {
                            // Handle potential security exceptions
                            console.log('Note: Could not close the other window due to browser security.');
                        }
                    }, { once: true });
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                    
                    // Try to position and resize our current window to left half
                    // Note: This may not work in all browsers due to security restrictions
                    try {
                        window.resizeTo(windowWidth, screenHeight);
                        window.moveTo(0, 0);
                    } catch (e) {
                        console.log('Note: Browser prevented window resizing.');
                    }
                }
            });
        });
    });
</script>
{% endblock %}