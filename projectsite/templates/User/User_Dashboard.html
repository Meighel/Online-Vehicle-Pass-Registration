{% extends 'includes/user_sidebar.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/user-dashboard-style.css' %}">
<link rel="stylesheet" href="{% static 'css/notifications.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="icon" href="{% static 'images/favicon.png' %}">
<style>
    /* Ensure main content shifts to the right of sidebar */
    .dashboard-wrapper {
        display: flex;
    }
    .main-content {
        flex-grow: 1;
        padding: 20px;
        margin-left: 120px;
    }
    /* Ensure cards and table have proper spacing */
    .dashboard-card {
        min-height: 140px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Mobile Menu Toggle Button -->
<button class="mobile-menu-toggle" id="mobile-menu-toggle">
    ☰
</button>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<div class="dashboard-wrapper">
    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid py-3">
            <!-- Title & Top Bar -->
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="title mb-3 mb-md-0">Dashboard</h2>
                <div class="d-flex align-items-center gap-3">
                    <!-- Notification Bell Button with Bootstrap Dropdown -->
                    <div class="dropdown" style="position: relative;">
                        <!-- Notification Bell Button -->
                        <button class="btn btn-outline-secondary position-relative" 
                                type="button" 
                                id="notificationDropdown" 
                                data-bs-toggle="dropdown" 
                                aria-expanded="false"
                                title="Notifications">
                            <i class="fas fa-bell" id="notification-bell"></i>
                            <!-- Red badge for unread count -->
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                                id="notification-badge" 
                                style="display: none; font-size: 0.6rem;">
                                0
                            </span>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <ul class="dropdown-menu dropdown-menu-end shadow" 
                            aria-labelledby="notificationDropdown" 
                            style="min-width: 350px; max-height: 400px; overflow-y: auto;">
                            
                            <!-- Header -->
                            <li class="dropdown-header d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Notifications</span>
                                <button class="btn btn-sm btn-link text-decoration-none p-0" 
                                        id="mark-all-read-btn" 
                                        onclick="notificationManager.markAllAsRead()">
                                    Mark all read
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            
                            <!-- Loading indicator -->
                            <li id="notifications-loading" class="dropdown-item-text text-center text-muted">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                Loading notifications...
                            </li>
                            
                            <!-- Notifications will be populated here -->
                            <div id="notification-dropdown-list">
                                <!-- Dynamic content -->
                            </div>
                            
                            <!-- Footer -->
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-center small text-muted" href="/notifications/">
                                    <i class="fas fa-list me-1"></i>View All Notifications
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <hr class="border-secondary">
            <small><span id="date" class="text-light"></span></small>

            <!-- Profile Card -->
            <div class="card profile-card p-4 mt-4 shadow-sm position-relative">

                <!-- Edit Button in the upper right
                <a href="#" class="btn btn-sm btn-primary position-absolute top-0 end-0 m-3">
                    Edit Profile
                </a> -->

                <!-- Profile Content -->
                <div class="d-flex flex-row align-items-center">
                    <div class="rounded-circle overflow-hidden border border-light d-flex align-items-center justify-content-center" style="width: 100px; height: 100px; background: #111;">
                        <span style="color: #FFD600; font-weight: bold; font-size: 2em;">
                            {% if profile %}
                                {{ profile.firstname|slice:":1"|upper }}{% if profile.middlename %}{{ profile.middlename|slice:":1"|upper }}{% endif %}{{ profile.lastname|slice:":1"|upper }}
                            {% else %}
                                ?
                            {% endif %}
                        </span>
                    </div>
                    <div class="profile-info ms-4">
                        <p class="fs-5 fw-bold">Name: {{ profile.firstname }} {{ profile.lastname }}</p>

                        {% if profile.school_role == "student" %}
                            <p>Student ID: {{ profile.corporate_email|slice:":9" }}</p>
                            <p>Driver License Number: {{ profile.dl_number }}</p>
                            <p>College: {{ profile.college }}</p>
                            <p>Program: {{ profile.program }}</p>
                            <p>Role: Student</p>

                        {% elif profile.school_role == "faculty" %}
                            <p>Faculty ID: {{ profile.corporate_email|slice:":9" }}</p>
                            <p>Driver License Number: {{ profile.dl_number }}</p>
                            <p>Department: {{ profile.department }}</p>
                            <p>Role: Faculty</p>

                        {% elif profile.school_role == "university personnel" %}
                            <p>Personnel ID: {{ profile.corporate_email|slice:":9" }}</p>
                            <p>Driver License Number: {{ profile.dl_number }}</p>
                            <p>Department: {{ profile.department }}</p>
                            <p>Role: University Personnel</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Application Tracker -->
            <div class="row mt-4 g-4">
                <div class="col-12">
                    <div class="card status-card border-primary shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title d-flex align-items-center mb-4">
                                <span class="text-primary fs-3">🚗</span>
                                <span class="ms-2">Application Status Tracker</span>
                            </h5>
                            
                            <!-- Status Timeline -->
                            <div class="status-timeline">
                                <!-- Step 1: Application Submitted - Always completed once submitted -->
                                <div class="timeline-step completed">
                                    <div class="timeline-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Application Submitted</h6>
                                        <small class="text-muted" style="color: rgb(93, 93, 93)  !important;">{{ registration.created_at|date:"M d, Y" }}</small>
                                    </div>
                                </div>
                                
                                <div class="timeline-connector {% if registration.status == 'initial approval' or registration.status == 'final approval' or registration.status == 'approved' or registration.status == 'sticker released' %}completed{% endif %}"></div>
                                
                                <!-- Step 2: Initial Approval - Active while pending/application submitted -->
                                <div class="timeline-step {% if registration.status == 'pending' or registration.status == 'application submitted' %}active{% elif registration.status == 'initial approval' or registration.status == 'final approval' or registration.status == 'approved' or registration.status == 'sticker released' %}completed{% endif %}">
                                    <div class="timeline-icon">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Initial Approval</h6>
                                        <small class="text-muted" style="color: rgb(93, 93, 93) !important;">Security Review</small>
                                    </div>
                                </div>
                                
                                <div class="timeline-connector {% if registration.status == 'final approval' or registration.status == 'approved' or registration.status == 'sticker released' %}completed{% endif %}"></div>
                                
                                <!-- Step 3: Final Approval - Active when initial approval done -->
                                <div class="timeline-step {% if registration.status == 'initial approval' %}active{% elif registration.status == 'final approval' or registration.status == 'approved' or registration.status == 'sticker released' %}completed{% endif %}">
                                    <div class="timeline-icon">
                                        <i class="fas fa-check-double"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Final Approval</h6>
                                        <small style="color: rgb(111, 112, 112) !important;">Security Verification</small>
                                    </div>
                                </div>
                                
                                <div class="timeline-connector {% if registration.status == 'approved' or registration.status == 'sticker released' %}completed{% endif %}"></div>
                                
                                <!-- Step 4: Approved - Active when final approval done, ready for inspection -->
                                <div class="timeline-step {% if registration.status == 'final approval' %}active{% elif registration.status == 'approved' or registration.status == 'sticker released' %}completed{% endif %}">
                                    <div class="timeline-icon">
                                        <i class="fas fa-clipboard-check"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Ready for Inspection</h6>
                                        <small style="color: rgb(93, 93, 93) !important;">Physical Inspection Required</small>
                                        {% if inspection %}
                                            <div class="mt-2 small text-info">
                                                <i class="fas fa-calendar-alt me-1"></i>
                                                Inspection: {{ inspection.physical_final_inspection_date|date:"M d, Y" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="timeline-connector {% if registration.status == 'sticker released' %}completed{% endif %}"></div>
                                
                                <!-- Step 5: Sticker Released - Final completed state -->
                                <div class="timeline-step {% if registration.status == 'approved' %}active{% elif registration.status == 'sticker released' %}completed{% endif %}">
                                    <div class="timeline-icon">
                                        <i class="fas fa-id-card"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6>Sticker Released</h6>
                                        <small style="color: rgb(93, 93, 93) !important;">Process Complete</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Current Status Box -->
                            <div class="alert alert-info mt-4 d-flex align-items-center">
                                <i class="fas fa-info-circle fs-4 me-3"></i>
                                <div>
                                    <strong>Current Status:</strong> 
                                    <span class="fs-5 ms-2">
                                        {% if registration.status == 'pending' or registration.status == 'application submitted' %}
                                            Waiting for Security Review
                                        {% elif registration.status == 'initial approval' %}
                                            Under Final Security Verification
                                        {% elif registration.status == 'final approval' %}
                                            Ready for Physical Inspection
                                        {% elif registration.status == 'approved' %}
                                            Processing Sticker Release
                                        {% elif registration.status == 'sticker released' %}
                                            Complete - Sticker Released
                                        {% else %}
                                            {{ registration.status|title }}
                                        {% endif %}
                                    </span>
                                    {% if registration.remarks %}
                                        <div class="mt-2 small">
                                            <strong>Remarks:</strong> {{ registration.remarks }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Access Card -->
                <div class="col-md-12">
                    <div class="card quick-access-card h-100 border-info shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title d-flex align-items-center">
                                📝 <span class="ms-2">Quick Access</span>
                            </h5>
                            <p class="mt-3">Apply for a new vehicle pass easily.</p>
                            <a href="{% url 'vehicle_registration_step_1' %}" class="btn btn-apply mt-2">Apply Now</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- <div class="container-fluid py-4">

                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card data-card">
                            <div class="card-header">
                                <h4 class="card-title"><i class="fas fa-history me-2"></i>Application History</h4>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-dark table-hover">
                                        <thead>
                                            <tr>
                                                <th>Reg. ID</th>
                                                <th>Vehicle</th>
                                                <th>Date Filed</th>
                                                <th>Status</th>
                                                <th>Remarks</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in history %}
                                            <tr>
                                                <td>{{ item.registration_number }}</td>
                                                <td>{{ item.vehicle.make_model|default:'N/A' }} ({{ item.vehicle.plate_number|default:'N/A' }})</td>
                                                <td>{{ item.date_of_filing|date:"M. d, Y" }}</td>
                                                <td>
                                                    <span class="status-badge status-{{ item.status|slugify }}">
                                                        {{ item.status|title }}
                                                    </span>
                                                </td>
                                                <td>{{ item.remarks|default:'-' }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center">No application history found.</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> -->
        </div> <!-- End Container -->
    </div> <!-- End Main Content -->
</div> <!-- End Dashboard Wrapper -->

<!-- Toast Container (for popup notifications) -->
<div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    <script src="{% static 'javascript/User_Dashboard.js' %}"></script>
    <script src="{% static 'javascript/notifications.js' %}"></script>
{% endblock %}